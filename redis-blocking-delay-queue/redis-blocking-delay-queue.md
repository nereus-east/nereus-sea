## 基于redis的延迟、阻塞队列

###### 使用场景

1. 订单 **超时** 未支付，要取消或者提醒用户
2. 下单未付款，**超过12小时** 则取消订单释放库存
3. 消费者为保证高可用，收到message后先缓存，消费成功后删除缓存，消费失败则过 **一段时间** 再重试，因为如果基础设施故障，立马重试大概率也是失败的。所以需要延迟
4. 短信平台设定了 **凌晨0点** 准时发送营销短信

###### 开发背景以及Q&A
1. 分布式，J.U.C DelayQueue虽好，可不是分布式的
2. 避免轮询，减少不必要的开销
3. 为什么不用Rabbit MQ？不纯粹...就想要一个纯粹的延迟队列
4. 为什么用Redis？性能好，且有天然的BLPOP这样的天然阻塞命令
5. 为什么用BRPOPLPUSH？为了保证消息不丢失，高可用

###### 设计思路
1. **延迟** 通过ZSET中的Score实现，Score设定为期望执行时间，获取到期的任务则很简单，只要获取Score>=当前时间即可
2. **阻塞** 通过List中的BRPOPLPUSH实现
3. **消息流转** 结合ZSET + List，同时job元数据存放在hash中，固整个流程如图

3. **避免轮询** 安排一个线程，单独通过wait/notify实现唤醒，
